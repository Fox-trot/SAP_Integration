Перем мВалютаРегламентированногоУчета;

Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
	
	Префикс=Организация.Префикс;
	ДобавитьПрефиксУзла(Префикс);
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ПриходДокумента = Платежи.Итог("Приход");
	РасходДокумента = Платежи.Итог("Расход");
	ПриходДокументаВВалюте = Платежи.Итог("ПриходВВалюте");
	РасходДокументаВВалюте = Платежи.Итог("РасходВВалюте");
	
КонецПроцедуры

Процедура ДвиженияПоБУ(Режим, Отказ, Заголовок ,СтруктураШапкиДокумента)
	
	ПроводкиБУ = Движения.Хозрасчетный;
	
	Для Каждого Платеж Из Платежи Цикл
		
		Если (Платеж.ВидДвижения=Перечисления.ВидДвиженияДенежныхСредствПоВыписке.Поступление) и
			 ((Платеж.КоррСчет.ПринадлежитЭлементу(ПланыСчетов.Хозрасчетный.А5100))  или 
			  (Платеж.КоррСчет.ПринадлежитЭлементу(ПланыСчетов.Хозрасчетный.А5200))  или
			  (Платеж.КоррСчет.ПринадлежитЭлементу(ПланыСчетов.Хозрасчетный.А5500))) Тогда
			 Продолжить;
		КонецЕсли;	
		
		//Если Не Платеж.ДополнительныйДокумент = Неопределено Тогда
			Если  Платеж.КоррСчет.Родитель=ПланыСчетов.Хозрасчетный.А5000 Тогда 
				Продолжить;
			КонецЕсли;	
		//КонецЕсли; 
		
		Если Платеж.ВидДвижения=Перечисления.ВидДвиженияДенежныхСредствПоВыписке.Поступление Тогда
			
			Проводка = ПроводкиБУ.Добавить();
			Проводка.Период      = Дата;
			Проводка.Организация = Организация;
			Проводка.Содержание = Платеж.ДеталиПлатежа;     
			Проводка.ПервичныйДокумент = СокрЛП(Платеж.ПлатежныйДокумент);     
			
			Проводка.СчетДт      = СчетБанк;
			Проводка.СубконтоДт.СтатьиДвиженияДенежныхСредств = Платеж.СтатьяДвиженияДенежныхСредств;
			Проводка.СубконтоДт.БанковскиеСчета = БанковскийСчет;
			
			Проводка.СчетКт     =  Платеж.КоррСчет;
			УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,1,Платеж.Субконто1);
			УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,2,Платеж.Субконто2);
			УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,3,Платеж.Субконто3);
			Проводка.Сумма = Платеж.Приход;
			
			Если СчетБанк.Валютный Тогда
				Проводка.ВалютаДт        = ВалютаДокумента;
				Проводка.ВалютнаяСуммаДт = Платеж.ПриходВВалюте;
			КонецЕсли;
			
			Если Платеж.КоррСчет.Валютный Тогда
				Проводка.ВалютаКт        = Платеж.Валюта;
				Проводка.ВалютнаяСуммаКт = Платеж.ПриходВКорВалюте;
			КонецЕсли;
			
		ИначеЕсли Платеж.ВидДвижения=Перечисления.ВидДвиженияДенежныхСредствПоВыписке.Списание	 Тогда
			
			
			Проводка = ПроводкиБУ.Добавить();
			Проводка.Период      = Дата;
			Проводка.Организация = Организация;
			Проводка.Содержание = Платеж.ДеталиПлатежа;     
			Проводка.ПервичныйДокумент = Сокрлп(Платеж.ПлатежныйДокумент);     
			
			Проводка.СчетДт     =  Платеж.КоррСчет;
			УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,1,Платеж.Субконто1);
			УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,2,Платеж.Субконто2);
			УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,3,Платеж.Субконто3);
			
			Проводка.СчетКт      = СчетБанк;
			Проводка.СубконтоКт.СтатьиДвиженияДенежныхСредств = Платеж.СтатьяДвиженияДенежныхСредств;
			Проводка.СубконтоКт.БанковскиеСчета = БанковскийСчет;
			Проводка.Сумма = Платеж.Расход;
			
			Если СчетБанк.Валютный Тогда
				Проводка.ВалютаКт        = ВалютаДокумента;
				Проводка.ВалютнаяСуммаКт = Платеж.РасходВВалюте;
			КонецЕсли;
			
			Если Платеж.КоррСчет.Валютный Тогда
				Проводка.ВалютаДт        = Платеж.Валюта;
				Проводка.ВалютнаяСуммаДт = Платеж.РасходВКорВалюте;
			КонецЕсли;
			
			
		КонецЕсли; 
		
	КонецЦикла; 
	
КонецПроцедуры

Процедура ДвиженияПоРегистрам(Режим, Отказ, Заголовок ,СтруктураШапкиДокумента)
	
	ДвиженияПоБУ(Режим, Отказ, Заголовок ,СтруктураШапкиДокумента);
		
КонецПроцедуры

Процедура ПроверитьЗаполнениеДокумента(Отказ, Заголовок, СтруктураШапкиДокумента)
	
	//Проверяем заполнение шапки
	СтруктураОбязательныхПолей = Новый Структура("Организация");
	СтруктураОбязательныхПолей.Вставить("БанковскийСчет","Не указан банковский счет выписки.");
	
	СтруктураОбязательныхПолей.Вставить("СчетБанк","Не указан счет учета");
	
	ПроверитьЗаполнениеШапкиДокумента(ЭтотОбъект, СтруктураОбязательныхПолей, Отказ, Заголовок);
	
	//Проверяем заполнение табличной части 
	
	СтруктураПолей = Новый Структура();
	СтруктураПолей.Вставить("ВидДвижения","Не указан вид движения");
	
	СтруктураПолей.Вставить("КоррСчет","Не указан кор. счет");
	СтруктураПолей.Вставить("СтатьяДвиженияДенежныхСредств","Не указана статья движения денежных средств");
	
	ПроверитьЗаполнениеТабличнойЧастиПлатежногоДокумента(ЭтотОбъект, "Платежи", СтруктураПолей, Отказ, Заголовок);
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
	
	Заголовок = ПредставлениеДокументаПриПроведении(Ссылка);
	
	СтруктураШапкиДокумента = СформироватьСтруктуруШапкиДокумента(ЭтотОбъект);
	
	//ПроверитьЗаполнениеДокумента(Отказ, Заголовок, СтруктураШапкиДокумента);
	
	Если Не Отказ Тогда
		
		ДвиженияПоРегистрам(Режим, Отказ, Заголовок, СтруктураШапкиДокумента);
		
		//Учет курсовых разниц
		Если (ВалютаДокумента <> мВалютаРегламентированногоУчета) тогда
			//ПереоценкаСчетовДокументаРегл(ЭтотОбъект,СтруктураШапкиДокумента, мВалютаРегламентированногоУчета,Отказ);
		КонецЕсли; 	
		
	КонецЕсли;
	
КонецПроцедуры

мВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
